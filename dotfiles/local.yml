---
- hosts: localhost
  connection: local
  become: true 

- pre_tasks:
  - name: Ensuring Homebrew Is Installed
    stat:
    path: /opt/homebrew/bin/brew
    register: homebrew_check

  - name: Fail If Homebrew Is Not Installed and install_homebrew_if_missing Is False
    fail:
      msg: Homebrew is missing, install from http://brew.sh
    when:
      - not homebrew_check.stat.exists
      - not install_homebrew_if_missing

  - name: Installing Homebrew
    shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    when:
      - not homebrew_check.stat.exists
      - install_homebrew_if_missing
  
  - name: Install software
    hosts: localhost
    become: false
    vars:
      brew_cask_packages: 
        - alfred
        - aws-vault
        - docker
        - gitkraken
        - iterm2
        - jetbrains-toolbox
        - kitty
        - lastpass
        - leapp
        - powershell
        - sdm
      Brew_packages:
        - awscli
        - cookiecutter
        - docker
        - fzf
        - gnupg
        - go
        - grep
        - helm
        - helmfile
        - leapp-cli-darwin-arm64
        - istioctl
        - jira-cli
        - jq
        - k9s
        - kube-capacity
        - kube-color
        - kube-ps1
        - kubectx
        - kubernetes-cli
        - terraform
        - tfenv
        - zsh-autocomplete
        - zsh-syntax-highlighting
      install_homebrew_if_missing: false
- tasks: 
  - name: Updating Homebrew
    homebrew: 
      update_homebrew: true
    when: homebrew_check.stat.exists

  - name: Upgrading Homebrew Packages
    homebrew: 
      upgrade_all: "{{ upgrade_homebrew_packages }}" 
    register: result
    until: result is successful
    when: homebrew_check.stat.exists
